name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Job 1: Compile Noir Contracts
  compile:
    name: Compile Contracts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Aztec CLI
        run: npm install -g @aztec/cli
      
      - name: Compile contracts
        run: npm run compile
      
      - name: Upload compiled artifacts
        uses: actions/upload-artifact@v3
        with:
          name: compiled-contracts
          path: target/
          retention-days: 7

  # Job 2: Run Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: compile
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Aztec CLI
        run: npm install -g @aztec/cli
      
      - name: Download compiled artifacts
        uses: actions/download-artifact@v3
        with:
          name: compiled-contracts
          path: target/
      
      - name: Run tests
        run: npm run test
      
      - name: Generate test report
        if: always()
        run: |
          echo "Test execution completed"
          echo "Check logs for details"

  # Job 3: Lint and Format Check
  lint:
    name: Lint and Format
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check formatting
        run: |
          echo "Formatting check (placeholder)"
          # Add actual formatting checks when linter is configured

  # Job 4: Security Scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: Check for vulnerable dependencies
        run: |
          echo "Security scan completed"
          # Add more security checks as needed

  # Job 5: Build Documentation
  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Verify documentation files
        run: |
          echo "Checking documentation..."
          test -f README.md && echo "âœ“ README.md exists"
          test -f SETUP.md && echo "âœ“ SETUP.md exists"
          test -f ARCHITECTURE.md && echo "âœ“ ARCHITECTURE.md exists"
          test -f CONTRIBUTING.md && echo "âœ“ CONTRIBUTING.md exists"
          test -f SECURITY.md && echo "âœ“ SECURITY.md exists"
          test -f CHANGELOG.md && echo "âœ“ CHANGELOG.md exists"

  # Job 6: Deployment Preview (on PR)
  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: [compile, test]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Download compiled artifacts
        uses: actions/download-artifact@v3
        with:
          name: compiled-contracts
          path: target/
      
      - name: Preview deployment info
        run: |
          echo "ðŸ“¦ Deployment Preview"
          echo "Branch: ${{ github.head_ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Contracts ready for testnet deployment"

  # Job 7: Tag Release (on main branch)
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [compile, test, lint, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Check for version bump
        id: version
        run: |
          VERSION=$(cat package.json | grep version | head -1 | awk -F: '{ print $2 }' | sed 's/[",]//g' | tr -d '[[:space:]]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"
      
      - name: Create Git tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          VERSION=${{ steps.version.outputs.version }}
          if ! git rev-parse "v$VERSION" >/dev/null 2>&1; then
            git tag -a "v$VERSION" -m "Release version $VERSION"
            git push origin "v$VERSION"
            echo "âœ“ Tagged release v$VERSION"
          else
            echo "Tag v$VERSION already exists"
          fi

# Workflow status notification
  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [compile, test, lint, security, docs]
    if: always()
    
    steps:
      - name: Workflow summary
        run: |
          echo "ðŸŽ‰ CI/CD Pipeline Completed"
          echo "Compile: ${{ needs.compile.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Docs: ${{ needs.docs.result }}"